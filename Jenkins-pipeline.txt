pipeline {
    agent any

    environment {
        BITBUCKET_TOKEN = 'ATCTT3xFfGN0JYTHt3e88bk1AF-fZYTZap8Q2k6ypbh1hx4hN2uDNBtAAVJyvGAksDpKRD-Wm-Eg3yG9NrgMHirufaqHSiv4FxI72YsfM9YazI7ilZGMGtaUWjld3lCTXVTnX82AY6zCTFf6jmtpbohpavztMTGRhD7awIplGao6OJ0Q8seztmg=F25F025A'
    }

    triggers {
        cron('H/10 * * * *')
    }

    stages {
        stage('Clone repository') {
            steps {
                script {
                    git credentialsId: '', url: "https://x-token-auth:${BITBUCKET_TOKEN}@bitbucket.org/course-auto/the-pyoneers.git", branch: 'master'
                }
            }
        }

        stage('Install dependencies') {
            steps {
                script {
                    sh 'pip3 install -r req.txt'
                }
            }
        }

        stage('Run tests') {
            steps {
               catchError {
                  script {
                        sh 'pytest tests/'
                  }
               }
            }
        }

        stage('Copy history') {
            steps {
                script {
                    sh 'cp -r allure-report/history allure-results/history'
                }
            }
        }

        stage('Report') {
            steps {
               allure([
                 includeProperties: false,
                 jdk: '',
                 properties: [],
                 reportBuildPolicy: 'ALWAYS',
                 results: [[path: '/var/jenkins_home/workspace/the-pyoneers/allure-results']]
               ])
            }
        }
    }
}
